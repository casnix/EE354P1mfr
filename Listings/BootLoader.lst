A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\BootLoader.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE BootLoader.asm SET(SMALL) DEBUG PRINT(.\Listings\BootLoader.lst) OBJECT
                      (.\Objects\BootLoader.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ; ------------- READS51 generated header -------------- 
                       2     ; module  : Y:\Development\8051\Bootstrapper\Bootstrapper\BootLoader.asm
                       3     ; created : 17:04:29, Saturday, August 25, 2018
                       4     ; ----------------------------------------------------- 
                       5     ;-- Matt Rienzo, BootLoader.asm 8/25/2018
                       6     ;#include "./include/asm/Registers.inc"
                +1     7     ; Matt Rienzo, Registers.inc 8/25/2018
                +1     8     
                +1     9     ;-- Alias/enumeration of registers and banks
  0000          +1    10     a0      equ     0
  0001          +1    11     a1      equ     1
  0002          +1    12     a2      equ     2
  0003          +1    13     a3      equ     3
  0004          +1    14     a4      equ     4
  0005          +1    15     a5      equ     5
  0006          +1    16     a6      equ     6
  0007          +1    17     a7      equ     7
  0008          +1    18     b0      equ     8
  0009          +1    19     b1      equ     9
  000A          +1    20     b2      equ     10
  000B          +1    21     b3      equ     11
  000C          +1    22     b4      equ     12
  000D          +1    23     b5      equ     13
  000E          +1    24     b6      equ     14
  000F          +1    25     b7      equ     15
  0010          +1    26     c0      equ     16
  0011          +1    27     c1      equ     17
  0012          +1    28     c2      equ     18
  0013          +1    29     c3      equ     19
  0014          +1    30     c4      equ     20
  0015          +1    31     c5      equ     21
  0016          +1    32     c6      equ     22
  0017          +1    33     c7      equ     23
                +1    34     
                +1    35     ;-- SFRs
                +1    36     ;sp  equ 0x81
                +1    37     ;acc equ 0xe0
  00F0          +1    38     bcc equ 0xf0
                +1    39     ;psw equ 0xd0
                      40     
                      41     ;#include "./include/asm/ShortStack.inc"
                +1    42     ; Matt Rienzo, ShortStack.inc 8/25/2018
                +1    43     
                +1    44     ; The following registers I am reserving for short stack operations
  0018          +1    45     s0      equ     0x18
  0019          +1    46     s1      equ     0x19
  001A          +1    47     s2      equ     0x1a
  001B          +1    48     s3      equ 0x1b
  001C          +1    49     s4      equ     0x1c
  001D          +1    50     s5      equ     0x1d
  001E          +1    51     s6      equ     0x1e
  001F          +1    52     s7      equ     0x1f
                +1    53     
                +1    54     
                +1    55     ; SHORT STACK -- see the Short Stack section after the END instruction for an explanation
                +1    56     ;  of what this is
                +1    57     ; Short stack address "register" and short stack size "register"
A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     2

  0020          +1    58     ss      equ     0x20    ; short stack 0 address
  0021          +1    59     ssz     equ 0x21        ; short stack size (index)
  0022          +1    60     msz     equ     0x22    ; short stack max size (to avoid overflow, but with stack wrapping/
                             overwrites)
                      61     
                      62     ;#include "./include/asm/MacroLang.inc"
                +1    63     ; Matt Rienzo, MacroLang.inc 8/25/2018
                +1    64     sspush          macro   x
                +1    65             push    x
                +1    66             lcall   __sspush
                +1    67     endm
                +1    68     
                +1    69     sspop           macro   x
                +1    70             lcall   __sspop
                +1    71             pop             x
                +1    72     endm
                +1    73     
                +1    74     sspushl         macro   N
                +1    75             mov             s0,             N
                +1    76             push    s0
                +1    77             lcall   __sspush
                +1    78     endm
                      79     
                      80     
                      81     
                      82     ;#define DEBUG
                      83     
                      84     ;-- Segment declaration
                      85     setup   segment code
                      86     boot    segment code
                      87     exit    segment code
                      88     memory  segment code
                      89             
0000                  90     org             0x0000
0000 020000   F       91             ljmp            __setup
                      92     
                      93     
                      94     
                      95     ;-- Segment definition
                      96         public  __sspush
                      97         public  __sspop
----                  98     rseg    memory
0000                  99             __sspush:  ; Takes a byte off the top of the stack and moves it to the short stack
                     100                     ; Increment our short stack index
                     101                     ; if([msz]-[ssz] == 0) [ssz] = 0;
                     102     
0000 E521            103             mov     a,      ssz
                     104     
                     105     
                                     
                                     
                             
0002 2401            109             add     a,      #0x01
                     110     
                                     
                                     
                             
                     114     
0004 9522            115             subb    a,      msz
                     116     
0006 B40003          117             cjne    a,      #0x00,  __sspush_continue
                     118                     
                     119                     ; Reset our ssz, wrapping our stack
0009 752100          120                     mov             ssz,    #0x00
                     121             
000C                 122             __sspush_continue:
A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     3

                     123                     ; Set our offset
                     124                     ; &s7 = ss+[ssz]
                     125     
000C 7420            126             mov     a,      #ss
                     127     
                     128     
                                     
                                     
                             
000E 2521            132             add     a,      ssz
                     133     
                                     
                             
                     136             ; Preserve our callback/ret address
0010 D01F            137             pop     s7
0012 D01E            138             pop     s6
                     139             
                     140             ; Argument
0014 D01D            141             pop     s5
0016 F8              142             mov     r0,     a
0017 A61D            143             mov     @r0,    s5
                     144     
0019 C01E            145             push    s6
001B C01F            146             push    s7
001D 22              147                     ret
                     148                     
001E                 149             __sspop:   ; Takes a byte off the top of the short stack and moves it to the stack
                     150     
001E 7420            151             mov     a,      #ss
                     152     
                     153     
                                             
                                             
                                     
                             
0020 2521            158             add     a,      ssz
                     159     
                     160             ; Preserve callback/ret address
0022 D019            161             pop     s1
0024 D01A            162             pop     s2
                     163     
0026 F8              164             mov     r0,     a
0027 861B            165             mov     s3,     @r0
0029 C01B            166             push    s3 ; Return byte
                     167                     
                     168                     ; Check if our offset is 0
                     169     
002B E521            170             mov     a,      ssz
002D B40002          171             cjne    a,      #0x00,  __sspop_continue
0030 2401            172             add     a,      #0x01
                     173     
                                     
                             
                     176                     
0032                 177             __sspop_continue:
0032 9401            178             subb    a,      #0x01
                     179     
                                     
                             
                     182                     
                     183             ; Callback/ret address
0034 C01A            184             push    s2
0036 C019            185             push    s1
0038 22              186                     ret
                     187     
                     188     
A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     4

                     189     
                     190         public  __setup             
----                 191     rseg    setup
0000                 192             __setup:
                     193                     ;---SHORT STACK
0000 752023          194                     mov             ss,             #0x23
0003 752100          195                     mov             ssz,    #0x00
0006 752220          196                     mov             msz,    #0x20
                     197                     ; The last slot in the short stack will be #([ss]+[msz])
                     198                     
                     199                     ;---STACK
                     200                     ; Set SP to 0x30
0009 758130          201                     mov             sp,             #0x30
                     202                     
                     203                     ; enter our program
000C 020000   F      204                     ljmp    __entry
                     205             
                     206             
                     207                     
----                 208     rseg    boot
                     209             extrn           code    (__HIL_init)
                     210             extrn           code    (__HAL_init)
                     211             extrn           code    (_Cmain)
0000                 212             __entry:
                     213             ; Do three things:      (1) tell the Hardware Interaction Layer to initialize
                     214             ;                                       (2) tell the Hardware Abstration Layer to i
                             nitialize
                     215             ;                                       (3) jump into the main program
0000 120000   F      216                     lcall   __HIL_init      ; pushes return code onto ss
                     217                     sspop   acc
0008 B4001B          220                     cjne    a,              #0x00,  __entry_HIL_error
                     221                     
000B 120000   F      222                     lcall   __HAL_init
                     223                     sspop   acc
0013 B40013          226                     cjne    a,              #0x00,  __entry_HAL_error
                     227                     
0016 74E4            228             mov     a,      #0xe4
0018 120000   F      229                     lcall   _Cmain
                     230                     sspop   acc
0020 B40009          233                     cjne    a,              #0x00,  __entry_main_error
                     234                     
0023 020000   F      235                     ljmp    __shutdown
                     236                     
0026                 237             __entry_HIL_error:      ; Turn on ERR LED
0026 020000   F      238                     ljmp    __shutdown
0029                 239             __entry_HAL_error:      ; Turn on ERR LED and batt_too_low square
0029 020000   F      240                     ljmp    __shutdown
002C                 241             __entry_main_error:     ; Turn on ERR LED and white square
002C 020000   F      242                     ljmp    __shutdown
                     243                     
                     244                     
----                 245     rseg    exit
0000                 246             __shutdown:
                     247                     ; Endless looooooop
0000 0100     F      248                     ajmp    __shutdown
                     249     end
A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     5

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

A0 . . . . . . . .  N NUMB   0000H   A   
A1 . . . . . . . .  N NUMB   0001H   A   
A2 . . . . . . . .  N NUMB   0002H   A   
A3 . . . . . . . .  N NUMB   0003H   A   
A4 . . . . . . . .  N NUMB   0004H   A   
A5 . . . . . . . .  N NUMB   0005H   A   
A6 . . . . . . . .  N NUMB   0006H   A   
A7 . . . . . . . .  N NUMB   0007H   A   
ACC. . . . . . . .  D ADDR   00E0H   A   
B0 . . . . . . . .  N NUMB   0008H   A   
B1 . . . . . . . .  N NUMB   0009H   A   
B2 . . . . . . . .  N NUMB   000AH   A   
B3 . . . . . . . .  N NUMB   000BH   A   
B4 . . . . . . . .  N NUMB   000CH   A   
B5 . . . . . . . .  N NUMB   000DH   A   
B6 . . . . . . . .  N NUMB   000EH   A   
B7 . . . . . . . .  N NUMB   000FH   A   
BCC. . . . . . . .  N NUMB   00F0H   A   
BOOT . . . . . . .  C SEG    002FH       REL=UNIT
C0 . . . . . . . .  N NUMB   0010H   A   
C1 . . . . . . . .  N NUMB   0011H   A   
C2 . . . . . . . .  N NUMB   0012H   A   
C3 . . . . . . . .  N NUMB   0013H   A   
C4 . . . . . . . .  N NUMB   0014H   A   
C5 . . . . . . . .  N NUMB   0015H   A   
C6 . . . . . . . .  N NUMB   0016H   A   
C7 . . . . . . . .  N NUMB   0017H   A   
EXIT . . . . . . .  C SEG    0002H       REL=UNIT
MEMORY . . . . . .  C SEG    0039H       REL=UNIT
MSZ. . . . . . . .  N NUMB   0022H   A   
S0 . . . . . . . .  N NUMB   0018H   A   
S1 . . . . . . . .  N NUMB   0019H   A   
S2 . . . . . . . .  N NUMB   001AH   A   
S3 . . . . . . . .  N NUMB   001BH   A   
S4 . . . . . . . .  N NUMB   001CH   A   
S5 . . . . . . . .  N NUMB   001DH   A   
S6 . . . . . . . .  N NUMB   001EH   A   
S7 . . . . . . . .  N NUMB   001FH   A   
SETUP. . . . . . .  C SEG    000FH       REL=UNIT
SP . . . . . . . .  D ADDR   0081H   A   
SS . . . . . . . .  N NUMB   0020H   A   
SSZ. . . . . . . .  N NUMB   0021H   A   
_CMAIN . . . . . .  C ADDR   -----       EXT
__ENTRY. . . . . .  C ADDR   0000H   R   SEG=BOOT
__ENTRY_HAL_ERROR.  C ADDR   0029H   R   SEG=BOOT
__ENTRY_HIL_ERROR.  C ADDR   0026H   R   SEG=BOOT
__ENTRY_MAIN_ERROR  C ADDR   002CH   R   SEG=BOOT
__HAL_INIT . . . .  C ADDR   -----       EXT
__HIL_INIT . . . .  C ADDR   -----       EXT
__SETUP. . . . . .  C ADDR   0000H   R   SEG=SETUP
__SHUTDOWN . . . .  C ADDR   0000H   R   SEG=EXIT
__SSPOP. . . . . .  C ADDR   001EH   R   SEG=MEMORY
__SSPOP_CONTINUE .  C ADDR   0032H   R   SEG=MEMORY
__SSPUSH . . . . .  C ADDR   0000H   R   SEG=MEMORY
__SSPUSH_CONTINUE.  C ADDR   000CH   R   SEG=MEMORY


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
A51 MACRO ASSEMBLER  BOOTLOADER                                                           09/28/2018 11:30:12 PAGE     6

